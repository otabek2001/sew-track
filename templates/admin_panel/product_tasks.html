{% extends 'base.html' %}
{% load static %}

{% block title %}Operatsiyalar - {{ product.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-8">
    <header class="bg-white border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center gap-3">
                <a href="{% url 'admin_panel:product_list' %}" class="text-gray-600">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </a>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">{{ product.name }}</h1>
                    <p class="text-sm text-gray-500">{{ product.article_code }} • Operatsiyalar va narxlar</p>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Add Task Form -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-6" x-data="{ showForm: false }">
            <button 
                @click="showForm = !showForm"
                class="w-full flex items-center justify-between p-4 bg-green-50 hover:bg-green-100 rounded-lg transition"
            >
                <span class="font-medium text-green-700">Yangi operatsiya qo'shish</span>
                <i data-lucide="plus-circle" class="w-5 h-5 text-green-600" :class="{'rotate-45': showForm}"></i>
            </button>
            
            <form method="post" action="{% url 'admin_panel:product_task_add' product.id %}" x-show="showForm" x-transition class="mt-4 space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium mb-2">Operatsiya <span class="text-red-500">*</span></label>
                    <select name="task_id" required class="w-full h-12 px-4 border-2 rounded-lg focus:border-green-500">
                        <option value="">Tanlang</option>
                        {% for task in available_tasks %}
                        <option value="{{ task.id }}">{{ task.code }} - {{ task.name_uz }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Asosiy narx <span class="text-red-500">*</span></label>
                        <input type="number" name="base_price" required min="0" step="100" placeholder="5000" class="w-full h-12 px-4 border-2 rounded-lg focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Premium narx</label>
                        <input type="number" name="premium_price" min="0" step="100" placeholder="7500" class="w-full h-12 px-4 border-2 rounded-lg focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Vaqt (daqiqa)</label>
                        <input type="number" name="estimated_minutes" value="30" min="1" class="w-full h-12 px-4 border-2 rounded-lg focus:border-green-500">
                    </div>
                </div>
                <button type="submit" class="w-full h-12 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">
                    Qo'shish
                </button>
            </form>
        </div>

        <!-- Linked Tasks List -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b">
                <h2 class="font-bold text-gray-800">Bog'langan operatsiyalar ({{ product_tasks.count }})</h2>
            </div>
            
            {% if product_tasks %}
            <div class="divide-y">
                {% for pt in product_tasks %}
                <div class="p-6" x-data="{ editing: false }">
                    <div x-show="!editing">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">{{ pt.task.name_uz }}</p>
                                <p class="text-sm text-gray-500">{{ pt.task.code }} • {{ pt.task.get_category_display }}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">Asosiy narx</p>
                                    <p class="text-lg font-bold text-green-600">{{ pt.base_price|floatformat:0 }} so'm</p>
                                </div>
                                <button @click="editing = true" class="text-blue-600 hover:text-blue-700">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <form method="post" action="{% url 'admin_panel:product_task_delete' pt.id %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-600 hover:text-red-700" onclick="return confirm('O\'chirilsinmi?')">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <form method="post" action="{% url 'admin_panel:product_task_update' pt.id %}" x-show="editing" x-transition class="space-y-3">
                        {% csrf_token %}
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-medium mb-1">Asosiy narx</label>
                                <input type="number" name="base_price" value="{{ pt.base_price }}" required min="0" step="100" class="w-full h-10 px-3 border-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Premium narx</label>
                                <input type="number" name="premium_price" value="{{ pt.premium_price }}" min="0" step="100" class="w-full h-10 px-3 border-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Vaqt (daq)</label>
                                <input type="number" name="estimated_minutes" value="{{ pt.estimated_minutes }}" min="1" class="w-full h-10 px-3 border-2 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="flex-1 h-9 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">Saqlash</button>
                            <button type="button" @click="editing = false" class="flex-1 h-9 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">Bekor qilish</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-12 text-center text-gray-500">
                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                <p>Hali operatsiya bog'lanmagan</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => lucide.createIcons());
</script>
{% endblock %}

