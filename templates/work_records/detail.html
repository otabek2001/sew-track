{% extends 'base.html' %}

{% block title %}Ish tafsilotlari - SEW-TRACK{% endblock %}

{% block content %}
<div class="min-h-screen pb-24 md:pb-8 bg-gray-50">
    <!-- Mobile Header -->
    <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
        <div class="px-4 py-4">
            <div class="flex items-center gap-3">
                <a href="{% url 'tasks:work_records_list' %}" class="text-gray-600 touch-feedback">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </a>
                <h1 class="text-xl font-bold text-gray-800">Ish haqida</h1>
            </div>
        </div>
    </header>

    <!-- Content -->
    <div class="p-4 space-y-4">
        <!-- Status Banner -->
        <div class="
            rounded-xl p-4 border-2
            {% if record.status == 'pending' %}
                bg-yellow-50 border-yellow-200
            {% elif record.status == 'completed' %}
                bg-green-50 border-green-200
            {% elif record.status == 'approved' %}
                bg-blue-50 border-blue-200
            {% else %}
                bg-red-50 border-red-200
            {% endif %}
        ">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-sm text-gray-600 mb-1">Holat</p>
                    <p class="text-lg font-bold
                        {% if record.status == 'pending' %}text-yellow-700
                        {% elif record.status == 'completed' %}text-green-700
                        {% elif record.status == 'approved' %}text-blue-700
                        {% else %}text-red-700{% endif %}
                    ">
                        {{ record.get_status_display }}
                    </p>
                </div>
                <i data-lucide="{% if record.status == 'approved' %}check-circle{% elif record.status == 'pending' %}clock{% elif record.status == 'completed' %}check{% else %}x-circle{% endif %}" class="w-12 h-12 
                    {% if record.status == 'pending' %}text-yellow-500
                    {% elif record.status == 'completed' %}text-green-500
                    {% elif record.status == 'approved' %}text-blue-500
                    {% else %}text-red-500{% endif %}
                "></i>
            </div>
            
            <!-- Rejection Reason (if rejected and notes exist) -->
            {% if record.status == 'rejected' and record.notes %}
            <div class="mt-4 pt-4 border-t-2 border-red-200">
                <div class="flex items-start gap-2">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0"></i>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-red-800 mb-1">Rad etish sababi:</p>
                        <p class="text-sm text-red-700 leading-relaxed">{{ record.notes }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Main Info Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Product -->
            <div class="p-4 border-b border-gray-100">
                <p class="text-sm text-gray-500 mb-1">Mahsulot</p>
                <p class="text-lg font-bold text-gray-800">{{ record.product.name }}</p>
                <p class="text-sm text-gray-600">{{ record.product.article_code }}</p>
            </div>

            <!-- Task -->
            <div class="p-4 border-b border-gray-100">
                <p class="text-sm text-gray-500 mb-1">Vazifa</p>
                <p class="text-lg font-bold text-gray-800">{{ record.task.name_uz }}</p>
                <p class="text-sm text-gray-600">{{ record.task.code }}</p>
            </div>

            <!-- Quantity & Payment -->
            <div class="p-4 bg-gray-50">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Miqdor</p>
                        <p class="text-2xl font-bold text-gray-800">{{ record.quantity }}</p>
                        <p class="text-xs text-gray-500">dona</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500 mb-1">Birlik narxi</p>
                        <p class="text-xl font-bold text-gray-800">{{ record.price_per_unit|floatformat:0 }}</p>
                        <p class="text-xs text-gray-500">so'm</p>
                    </div>
                </div>
                <div class="pt-4 border-t-2 border-gray-200">
                    <p class="text-sm text-gray-500 mb-1">Jami to'lov</p>
                    <p class="text-3xl font-bold text-blue-600">{{ record.total_payment|floatformat:0 }}</p>
                    <p class="text-xs text-gray-500">so'm</p>
                </div>
            </div>
        </div>

        <!-- Date & Time Info -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Ish sanasi</span>
                    <span class="font-medium text-gray-800">{{ record.work_date|date:"d.m.Y" }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Yaratilgan vaqt</span>
                    <span class="font-medium text-gray-800">{{ record.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                {% if record.approved_by %}
                <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                    <span class="text-sm text-gray-600">Tasdiqlagan</span>
                    <span class="font-medium text-gray-800">{{ record.approved_by.full_name }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Tasdiqlangan vaqt</span>
                    <span class="font-medium text-gray-800">{{ record.approved_at|date:"d.m.Y H:i" }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Notes -->
        {% if record.notes %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <p class="text-sm text-gray-500 mb-2">Izoh</p>
            <p class="text-gray-800">{{ record.notes }}</p>
        </div>
        {% endif %}

        <!-- Actions (Only for pending status) -->
        {% if record.status == 'pending' %}
        <div class="space-y-3 pt-4" x-data="{ showEdit: false, showDelete: false }">
            <!-- Edit Button -->
            <button 
                @click="showEdit = !showEdit"
                class="w-full h-12 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition flex items-center justify-center gap-2 touch-feedback"
            >
                <i data-lucide="edit" class="w-5 h-5"></i>
                <span>Tahrirlash</span>
            </button>

            <!-- Edit Form -->
            <div x-show="showEdit" x-transition class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <form method="post" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Miqdor</label>
                        <input 
                            type="number" 
                            name="quantity"
                            value="{{ record.quantity }}"
                            min="1"
                            required
                            class="w-full h-12 px-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-100 focus:outline-none"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Izoh</label>
                        <textarea 
                            name="notes"
                            rows="3"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-100 focus:outline-none"
                        >{{ record.notes }}</textarea>
                    </div>
                    
                    <div class="flex gap-3">
                        <button 
                            type="submit"
                            class="flex-1 h-12 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition touch-feedback"
                        >
                            Saqlash
                        </button>
                        <button 
                            type="button"
                            @click="showEdit = false"
                            class="flex-1 h-12 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition touch-feedback"
                        >
                            Bekor qilish
                        </button>
                    </div>
                </form>
            </div>

            <!-- Delete Button -->
            <button 
                @click="showDelete = !showDelete"
                class="w-full h-12 bg-red-50 hover:bg-red-100 text-red-600 font-medium rounded-lg transition flex items-center justify-center gap-2 touch-feedback"
            >
                <i data-lucide="trash-2" class="w-5 h-5"></i>
                <span>Ishni o'chirish</span>
            </button>

            <!-- Delete Confirmation -->
            <div x-show="showDelete" x-transition class="bg-red-50 border-2 border-red-200 rounded-xl p-4">
                <p class="text-red-700 font-medium mb-4">Haqiqatan ham bu ishni o'chirmoqchimisiz?</p>
                <form method="post" class="flex gap-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <button 
                        type="submit"
                        class="flex-1 h-12 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition touch-feedback"
                    >
                        Ha, ishni o'chirish
                    </button>
                    <button 
                        type="button"
                        @click="showDelete = false"
                        class="flex-1 h-12 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition touch-feedback"
                    >
                        Yo'q
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Back Button -->
        <a 
            href="{% url 'tasks:work_records_list' %}"
            class="block w-full h-12 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition flex items-center justify-center gap-2 touch-feedback"
        >
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span>Ishlar ro'yxatiga qaytish</span>
        </a>
    </div>
</div>
{% endblock %}

